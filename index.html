<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Workout Tracker</title>
  <style>
    :root {
      --bg: #0e1116;
      --panel: #151926;
      --card: #1b2132;
      --text: #e6e9ee;
      --muted: #aab3c2;
      --ring: rgba(255,255,255,.08);
      --accent: #7dd3fc;
      --success: #22c55e;
      --warning: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: linear-gradient(180deg, #0c1018 0%, #0e1116 100%);
      color: var(--text);
      font: 500 16px/1.45 system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      position: sticky;
      top: 0;
      background: rgba(14,17,22,.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--ring);
      z-index: 100;
      padding: 16px 20px;
      margin: 0 -20px 20px;
    }
    h1 {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--accent);
    }
    .tm-config {
      background: var(--panel);
      border: 1px solid var(--ring);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .tm-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .tm-input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .tm-input-group label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }
    .tm-input-group input {
      margin: 0;
    }
    .week-selector {
      margin-top: 12px;
    }
    .week-selector label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    .collapsible-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--panel);
      border-radius: 8px;
      margin-bottom: 12px;
      user-select: none;
    }
    .collapsible-header:hover {
      background: var(--card);
    }
    .collapsible-arrow {
      transition: transform 0.2s;
      font-size: 14px;
    }
    .collapsible-arrow.open {
      transform: rotate(180deg);
    }
    select, input, button {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--ring);
      background: var(--panel);
      color: var(--text);
      font: inherit;
      font-size: 15px;
    }
    select, input {
      margin-bottom: 12px;
    }
    button {
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    button:hover {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    button:active {
      transform: scale(0.98);
    }
    .timer-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 16px 0;
    }
    .timer-buttons button {
      margin: 0;
    }
    .timer-display {
      font-size: 48px;
      font-weight: 700;
      text-align: center;
      padding: 30px;
      background: var(--panel);
      border-radius: 12px;
      margin: 16px 0;
      font-variant-numeric: tabular-nums;
    }
    .timer-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th {
      text-align: left;
      padding: 12px 8px;
      border-bottom: 2px solid var(--ring);
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--ring);
    }
    .exercise-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .prescribed {
      color: var(--muted);
      font-size: 14px;
    }
    .log-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .log-inputs input {
      margin: 0;
      width: 100%;
      padding: 14px 12px;
      font-size: 16px;
    }
    .add-set-btn {
      margin: 0;
      padding: 14px 20px;
      font-size: 16px;
      width: 100%;
    }
    .logged-sets {
      margin-top: 12px;
      font-size: 14px;
    }
    .logged-set {
      display: inline-block;
      background: var(--panel);
      padding: 6px 12px;
      border-radius: 8px;
      margin: 4px 4px 4px 0;
      border: 1px solid var(--ring);
      font-weight: 500;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .hidden {
      display: none;
    }
    @media (max-width: 768px) {
      .log-inputs {
        grid-template-columns: 1fr;
      }
      .tm-grid {
        grid-template-columns: 1fr;
      }
      .add-set-btn {
        margin-top: 8px;
      }
    }
  </style>
  <meta name="theme-color" content="#0e1116">
  <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header>
    <h1>üí™ Workout Tracker</h1>
  </header>

  <div class="container">
    <!-- Workout Selection -->
    <div class="card">
      <label for="workout-select" class="section-title">Select Workout</label>
      <select id="workout-select">
        <option value="">-- Choose a workout --</option>
      </select>
    </div>

    <!-- Workout Display -->
    <div class="card" id="workout-card" style="display: none;">
      <div class="section-title" id="workout-title"></div>
      
      <!-- TM Calculator -->
      <div id="tm-calculator" style="display: none;">
        <div class="collapsible-header" onclick="toggleTMCalculator()">
          <span style="font-weight: 600;">‚öôÔ∏è Training Max Calculator</span>
          <span class="collapsible-arrow" id="tm-arrow">‚ñº</span>
        </div>
        <div id="tm-content" style="display: none;">
          <div class="tm-config">
            <div class="tm-grid">
              <div class="tm-input-group">
                <label>Squat TM (lb)</label>
                <input type="number" id="tm-squat" min="0" step="5" value="315" onchange="updateTMs()">
              </div>
              <div class="tm-input-group">
                <label>Bench TM (lb)</label>
                <input type="number" id="tm-bench" min="0" step="5" value="225" onchange="updateTMs()">
              </div>
              <div class="tm-input-group">
                <label>Deadlift TM (lb)</label>
                <input type="number" id="tm-dead" min="0" step="5" value="405" onchange="updateTMs()">
              </div>
              <div class="tm-input-group">
                <label>Overhead Press TM (lb)</label>
                <input type="number" id="tm-ohp" min="0" step="5" value="135" onchange="updateTMs()">
              </div>
            </div>
            <div class="week-selector">
              <label>Week/Cycle</label>
              <select id="week-select" onchange="updateTMs()">
                <option value="1">Week 1: 65/75/85 √ó 5+</option>
                <option value="2">Week 2: 70/80/90 √ó 3+</option>
                <option value="3">Week 3: 75/85/95 √ó 1+</option>
                <option value="4">Week 4: Deload 40/50/60 √ó 5</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <table id="workout-table">
        <thead>
          <tr>
            <th>Exercise</th>
            <th>Log Sets</th>
          </tr>
        </thead>
        <tbody id="workout-body"></tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div class="card empty-state" id="empty-state">
      <p>üëÜ Select a workout above to get started</p>
    </div>

    <!-- Rest Timer -->
    <div class="card" id="timer-card" style="display: none;">
      <div class="section-title">Rest Timer</div>
      <div class="timer-buttons">
        <button onclick="setTimer(30)">30s</button>
        <button onclick="setTimer(60)">60s</button>
        <button onclick="setTimer(90)">90s</button>
      </div>
      <div class="timer-display" id="timer-display">0:00</div>
      <div class="timer-controls">
        <button onclick="startTimer()">Start</button>
        <button onclick="pauseTimer()">Pause</button>
        <button onclick="resetTimer()">Reset</button>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <button onclick="saveWorkout()" style="margin-bottom: 10px;">üíæ Save Progress</button>
      <button onclick="loadWorkout()" style="margin-bottom: 10px;">üìÇ Load Progress</button>
      <button onclick="exportWorkout()">üì§ Export as Text</button>
    </div>
  </div>

  <script>
    // ============================================
    // WORKOUT PROGRAMS DATA
    // ============================================

    const WORKOUTS = {
      // 5/3/1 BBB Program
      'bbb-ohp': {
        name: '5/3/1 BBB - Day 1: Overhead Press',
        program: 'bbb',
        exercises: [
          { name: 'Overhead Press', prescribed: '65% TM √ó 5', type: 'main' },
          { name: 'Overhead Press', prescribed: '75% TM √ó 5', type: 'main' },
          { name: 'Overhead Press', prescribed: '85% TM √ó 5+ (AMRAP)', type: 'main' },
          { name: 'Overhead Press (BBB)', prescribed: '50% TM √ó 10 (5 sets)', type: 'bbb' },
          { name: 'Dips', prescribed: '3 √ó 10', type: 'accessory' },
          { name: 'Lateral Raises', prescribed: '3 √ó 12', type: 'accessory' }
        ]
      },
      'bbb-dead': {
        name: '5/3/1 BBB - Day 2: Deadlift',
        program: 'bbb',
        exercises: [
          { name: 'Deadlift', prescribed: '65% TM √ó 5', type: 'main' },
          { name: 'Deadlift', prescribed: '75% TM √ó 5', type: 'main' },
          { name: 'Deadlift', prescribed: '85% TM √ó 5+ (AMRAP)', type: 'main' },
          { name: 'Deadlift (BBB)', prescribed: '50% TM √ó 10 (5 sets)', type: 'bbb' },
          { name: 'Back Extensions', prescribed: '3 √ó 10', type: 'accessory' },
          { name: 'Hanging Leg Raises', prescribed: '3 √ó 12', type: 'accessory' }
        ]
      },
      'bbb-bench': {
        name: '5/3/1 BBB - Day 3: Bench Press',
        program: 'bbb',
        exercises: [
          { name: 'Bench Press', prescribed: '65% TM √ó 5', type: 'main' },
          { name: 'Bench Press', prescribed: '75% TM √ó 5', type: 'main' },
          { name: 'Bench Press', prescribed: '85% TM √ó 5+ (AMRAP)', type: 'main' },
          { name: 'Bench Press (BBB)', prescribed: '50% TM √ó 10 (5 sets)', type: 'bbb' },
          { name: 'DB Incline Press', prescribed: '3 √ó 10', type: 'accessory' },
          { name: 'Triceps Pushdowns', prescribed: '3 √ó 12', type: 'accessory' }
        ]
      },
      'bbb-squat': {
        name: '5/3/1 BBB - Day 4: Squat',
        program: 'bbb',
        exercises: [
          { name: 'Squat', prescribed: '65% TM √ó 5', type: 'main' },
          { name: 'Squat', prescribed: '75% TM √ó 5', type: 'main' },
          { name: 'Squat', prescribed: '85% TM √ó 5+ (AMRAP)', type: 'main' },
          { name: 'Squat (BBB)', prescribed: '50% TM √ó 10 (5 sets)', type: 'bbb' },
          { name: 'Leg Press', prescribed: '3 √ó 10', type: 'accessory' },
          { name: 'Walking Lunges', prescribed: '3 √ó 12/leg', type: 'accessory' }
        ]
      },

      // Science-Based Program
      'sci-back1': {
        name: 'Science-Based - Back Workout 1',
        program: 'science',
        exercises: [
          { name: 'Scap Pull-Down Primer', prescribed: '1-2 √ó 10-15 (submaximal)' },
          { name: 'Seated Cable Row (Wide Elbows)', prescribed: '2-3 √ó 6-8 (to form failure)' },
          { name: 'Narrow-Grip Lat Pulldown', prescribed: '2-3 √ó 10-12 (to failure + partials)' },
          { name: 'Straight-Arm Pushdown', prescribed: '2-3 √ó 8-10 (to eccentric failure)' },
          { name: 'One-and-a-Half Rep DB Pullover Ladder', prescribed: '1 √ó to failure' },
          { name: 'Banded/Bodyweight Pull-Up', prescribed: '1 √ó to failure (+ partials)' }
        ]
      },
      'sci-back2': {
        name: 'Science-Based - Back Workout 2',
        program: 'science',
        exercises: [
          { name: 'Face Pull (Primer)', prescribed: '2 √ó submaximal' },
          { name: 'Barbell Row or Chest-Supported Row', prescribed: '2-3 √ó 6-8 (to form failure)' },
          { name: 'Wide-Grip Pulldown', prescribed: '2-3 √ó 10-12 (to failure + partials)' },
          { name: 'Dumbbell High Pull', prescribed: '2-3 √ó 8-10 (to form failure)' },
          { name: 'One-and-a-Half Rep High Cable Row Ladder', prescribed: '1 √ó to failure/arm' },
          { name: 'Inverted Row', prescribed: '1 √ó to failure (+ partials)' }
        ]
      },
      'sci-chest1': {
        name: 'Science-Based - Chest Workout 1',
        program: 'science',
        exercises: [
          { name: 'Banded External Rotation (Primer)', prescribed: '1-2 √ó submaximal' },
          { name: 'Incline DB Bench Press (Thumbs Up)', prescribed: '3 √ó 5-8' },
          { name: 'Cable Crossover', prescribed: '3 √ó 10-12 (to failure + partials)' },
          { name: 'DB Floor Fly (Mechanical Drop Set)', prescribed: '2-3 √ó 8-10 (to eccentric failure)' },
          { name: 'Deficit One-and-a-Half Rep Push-Up Ladder', prescribed: '1 √ó to failure' },
          { name: 'Bodyweight Dip', prescribed: '1 √ó to failure (+ partials)' }
        ]
      },
      'sci-chest2': {
        name: 'Science-Based - Chest Workout 2',
        program: 'science',
        exercises: [
          { name: 'Band Pull-Apart (Primer)', prescribed: '1-2 √ó submaximal' },
          { name: 'Dumbbell Bench Press', prescribed: '3 √ó 5-8' },
          { name: 'High-to-Low Cable Crossover', prescribed: '3 √ó 10-12 (to failure + partials)' },
          { name: 'Incline Cable Press', prescribed: '2-3 √ó 8-10 (to failure)' },
          { name: 'Dip (Stretch Ladder)', prescribed: '1 √ó to failure' },
          { name: 'Prison Yard Push-Up', prescribed: '1 √ó to failure' }
        ]
      },
      'sci-legs1': {
        name: 'Science-Based - Legs Workout 1',
        program: 'science',
        exercises: [
          { name: 'Reverse Hyper (Primer)', prescribed: '1-2 √ó 10-15' },
          { name: 'Deadlift', prescribed: '3 √ó 5' },
          { name: 'Barbell Front Squat', prescribed: '2-3 √ó 6-8' },
          { name: 'Alternating DB Reverse Lunge', prescribed: '2-3 √ó 10/leg (to failure)' },
          { name: 'Seated Hamstring Curl', prescribed: '1 √ó 12-15 (to eccentric failure)' },
          { name: 'Standing Calf Raise', prescribed: '2-3 √ó to failure' }
        ]
      },
      'sci-legs2': {
        name: 'Science-Based - Legs Workout 2',
        program: 'science',
        exercises: [
          { name: 'Banded Overhead Squat (Primer)', prescribed: '1-2 √ó 10-15' },
          { name: 'Barbell Back Squat', prescribed: '3 √ó 7' },
          { name: 'Barbell Hip Thrust', prescribed: '2-3 √ó 6-8' },
          { name: 'Dumbbell Spanish Squat', prescribed: '2-3 √ó 10 (to failure)' },
          { name: 'Glute-Ham Raise (GHR)', prescribed: '1 √ó to failure (with eccentrics)' },
          { name: 'Seated Calf Raise', prescribed: '2-3 √ó 10-12 (to failure + partials)' }
        ]
      },
      'sci-triceps1': {
        name: 'Science-Based - Triceps Workout 1',
        program: 'science',
        exercises: [
          { name: 'Tricep Push Down', prescribed: '2-3 √ó 6-8 (to failure)' },
          { name: 'Lying Dumbbell Extension', prescribed: '2-3 √ó 8-10 (to failure + eccentrics)' },
          { name: 'Dumbbell/Cable Tricep Kickback', prescribed: '2-3 √ó 10-12 (to failure + partials)' },
          { name: 'Cobra Push-Up', prescribed: '1 √ó to failure' }
        ]
      },
      'sci-shoulders1': {
        name: 'Science-Based - Shoulders Workout 1',
        program: 'science',
        exercises: [
          { name: 'Lateral Raise (Dumbbell)', prescribed: 'Ignition: 1 √ó 8-12 to failure; then mini-sets' },
          { name: 'Overhead Press (Dumbbell)', prescribed: 'As Push Press ‚Äî Ignition set 1 √ó 8-12' }
        ]
      },

      // Powerlifting Program - Week 1-4
      'power-w14-mon': {
        name: 'Powerlifting - Week 1-4 Monday (Squat Focus)',
        program: 'powerlifting',
        exercises: [
          { name: 'Squat', prescribed: '4 √ó 5' },
          { name: 'Bench', prescribed: '3 √ó 8' },
          { name: 'Row', prescribed: '3 √ó 10' },
          { name: 'Plank', prescribed: '3 √ó 30s' }
        ]
      },
      'power-w14-tue': {
        name: 'Powerlifting - Week 1-4 Tuesday (Bench Focus)',
        program: 'powerlifting',
        exercises: [
          { name: 'Bench', prescribed: '4 √ó 5' },
          { name: 'Squat', prescribed: '3 √ó 8' },
          { name: 'OH Press', prescribed: '3 √ó 10' },
          { name: 'Leg Raise', prescribed: '3 √ó 10' }
        ]
      },
      'power-w14-thu': {
        name: 'Powerlifting - Week 1-4 Thursday (Deadlift Focus)',
        program: 'powerlifting',
        exercises: [
          { name: 'Deadlift', prescribed: '4 √ó 5' },
          { name: 'Bench', prescribed: '3 √ó 8' },
          { name: 'Pull-Up', prescribed: '3 √ó 8' },
          { name: 'Core: Russian Twists', prescribed: '3 √ó 20' }
        ]
      },
      'power-w14-fri': {
        name: 'Powerlifting - Week 1-4 Friday (Full Body)',
        program: 'powerlifting',
        exercises: [
          { name: 'Squat', prescribed: '3 √ó 5' },
          { name: 'Deadlift', prescribed: '3 √ó 5' },
          { name: 'Bench', prescribed: '3 √ó 5' },
          { name: 'Dip', prescribed: '3 √ó 10' }
        ]
      },

      // Bodyweight Program - Week 1-4
      'body-w14-mon': {
        name: 'Bodyweight - Week 1-4 Monday (Push/Pull)',
        program: 'bodyweight',
        exercises: [
          { name: 'Push-Up', prescribed: '4 √ó 8' },
          { name: 'Pull-Up', prescribed: '4 √ó 6' },
          { name: 'Dip', prescribed: '3 √ó 10' },
          { name: 'Plank', prescribed: '3 √ó 30s' }
        ]
      },
      'body-w14-tue': {
        name: 'Bodyweight - Week 1-4 Tuesday (Legs/Core)',
        program: 'bodyweight',
        exercises: [
          { name: 'Squat', prescribed: '4 √ó 15/leg' },
          { name: 'Lunge', prescribed: '3 √ó 12/leg' },
          { name: 'Leg Raise', prescribed: '3 √ó 10' },
          { name: 'Superman', prescribed: '3 √ó 15' }
        ]
      },
      'body-w14-thu': {
        name: 'Bodyweight - Week 1-4 Thursday (Push/Legs)',
        program: 'bodyweight',
        exercises: [
          { name: 'Push-Up', prescribed: '4 √ó 10' },
          { name: 'Pistol Squat', prescribed: '3 √ó 6/leg' },
          { name: 'Dip', prescribed: '3 √ó 12' },
          { name: 'Side Plank', prescribed: '3 √ó 20s/side' }
        ]
      },
      'body-w14-fri': {
        name: 'Bodyweight - Week 1-4 Friday (Pull/Core)',
        program: 'bodyweight',
        exercises: [
          { name: 'Inverted Row', prescribed: '4 √ó 10' },
          { name: 'Chin-Up', prescribed: '4 √ó 8' },
          { name: 'Leg Raise', prescribed: '3 √ó 12' },
          { name: 'Bird Dog', prescribed: '3 √ó 10/side' }
        ]
      }
    };

    // ============================================
    // STATE MANAGEMENT
    // ============================================

    let currentWorkout = null;
    let workoutLog = {};
    let timerSeconds = 0;
    let timerInterval = null;
    let tmValues = { squat: 315, bench: 225, dead: 405, ohp: 135 };
    let currentWeek = '1';

    // Load state from localStorage
    function loadState() {
      try {
        const saved = localStorage.getItem('workout_tracker_log');
        if (saved) {
          workoutLog = JSON.parse(saved);
        }
        const savedTMs = localStorage.getItem('workout_tracker_tms');
        if (savedTMs) {
          tmValues = JSON.parse(savedTMs);
        }
        const savedWeek = localStorage.getItem('workout_tracker_week');
        if (savedWeek) {
          currentWeek = savedWeek;
        }
      } catch (e) {
        console.error('Failed to load state:', e);
      }
    }

    // Save state to localStorage
    function saveState() {
      try {
        localStorage.setItem('workout_tracker_log', JSON.stringify(workoutLog));
        localStorage.setItem('workout_tracker_tms', JSON.stringify(tmValues));
        localStorage.setItem('workout_tracker_week', currentWeek);
      } catch (e) {
        console.error('Failed to save state:', e);
      }
    }

    // ============================================
    // TM CALCULATOR
    // ============================================

    function toggleTMCalculator() {
      const content = document.getElementById('tm-content');
      const arrow = document.getElementById('tm-arrow');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.classList.add('open');
      } else {
        content.style.display = 'none';
        arrow.classList.remove('open');
      }
    }
    window.toggleTMCalculator = toggleTMCalculator;

    function updateTMs() {
      tmValues.squat = parseFloat(document.getElementById('tm-squat').value) || 0;
      tmValues.bench = parseFloat(document.getElementById('tm-bench').value) || 0;
      tmValues.dead = parseFloat(document.getElementById('tm-dead').value) || 0;
      tmValues.ohp = parseFloat(document.getElementById('tm-ohp').value) || 0;
      currentWeek = document.getElementById('week-select').value;
      saveState();
      if (currentWorkout) {
        displayWorkout(currentWorkout);
      }
    }
    window.updateTMs = updateTMs;

    function getWeekPercentages(week) {
      const percentages = {
        '1': [0.65, 0.75, 0.85],
        '2': [0.70, 0.80, 0.90],
        '3': [0.75, 0.85, 0.95],
        '4': [0.40, 0.50, 0.60]
      };
      return percentages[week] || percentages['1'];
    }

    function calculateWeight(tm, percentage, round = 5) {
      const weight = tm * percentage;
      return Math.round(weight / round) * round;
    }

    function getLiftTM(exerciseName) {
      const lowerName = exerciseName.toLowerCase();
      if (lowerName.includes('squat')) return tmValues.squat;
      if (lowerName.includes('bench')) return tmValues.bench;
      if (lowerName.includes('deadlift')) return tmValues.dead;
      if (lowerName.includes('overhead press') || lowerName.includes('ohp')) return tmValues.ohp;
      return 0;
    }

    // ============================================
    // WORKOUT SELECTION & DISPLAY
    // ============================================

    function initWorkoutSelect() {
      const select = document.getElementById('workout-select');
      
      // Group workouts by program
      const groups = {
        '5/3/1 BBB': ['bbb-ohp', 'bbb-dead', 'bbb-bench', 'bbb-squat'],
        'Science-Based': ['sci-back1', 'sci-back2', 'sci-chest1', 'sci-chest2', 'sci-legs1', 'sci-legs2', 'sci-triceps1', 'sci-shoulders1'],
        'Powerlifting (Week 1-4)': ['power-w14-mon', 'power-w14-tue', 'power-w14-thu', 'power-w14-fri'],
        'Bodyweight (Week 1-4)': ['body-w14-mon', 'body-w14-tue', 'body-w14-thu', 'body-w14-fri']
      };

      Object.entries(groups).forEach(([groupName, workoutIds]) => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = groupName;
        workoutIds.forEach(id => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = WORKOUTS[id].name;
          optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
      });

      select.addEventListener('change', (e) => {
        if (e.target.value) {
          displayWorkout(e.target.value);
        } else {
          hideWorkout();
        }
      });
    }

    function displayWorkout(workoutId) {
      currentWorkout = workoutId;
      const workout = WORKOUTS[workoutId];
      
      document.getElementById('workout-title').textContent = workout.name;
      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('workout-card').style.display = 'block';
      document.getElementById('timer-card').style.display = 'block'; // Show timer

      // Show TM calculator for BBB workouts
      const tmCalc = document.getElementById('tm-calculator');
      if (workout.program === 'bbb') {
        tmCalc.style.display = 'block';
        // Populate TM values
        document.getElementById('tm-squat').value = tmValues.squat;
        document.getElementById('tm-bench').value = tmValues.bench;
        document.getElementById('tm-dead').value = tmValues.dead;
        document.getElementById('tm-ohp').value = tmValues.ohp;
        document.getElementById('week-select').value = currentWeek;
      } else {
        tmCalc.style.display = 'none';
      }

      const tbody = document.getElementById('workout-body');
      tbody.innerHTML = '';

      workout.exercises.forEach((exercise, idx) => {
        const tr = document.createElement('tr');
        
        // Calculate weight for BBB main lifts
        let calculatedWeight = '';
        let suggestedReps = '';
        if (workout.program === 'bbb' && exercise.type === 'main') {
          const tm = getLiftTM(exercise.name);
          const percentages = getWeekPercentages(currentWeek);
          const setIndex = workout.exercises.slice(0, idx).filter(e => e.type === 'main' && e.name === exercise.name).length;
          if (setIndex < 3) {
            calculatedWeight = calculateWeight(tm, percentages[setIndex]);
            const repsMap = { '1': '5', '2': '3', '3': '1', '4': '5' };
            suggestedReps = setIndex === 2 ? repsMap[currentWeek] + '+' : repsMap[currentWeek];
          }
        } else if (workout.program === 'bbb' && exercise.type === 'bbb') {
          const tm = getLiftTM(exercise.name.replace(' (BBB)', ''));
          calculatedWeight = calculateWeight(tm, 0.5);
          suggestedReps = '10';
        }
        
        // Exercise name + prescribed info
        const tdName = document.createElement('td');
        let prescribedText = exercise.prescribed;
        if (calculatedWeight) {
          prescribedText += ` ‚Üí ${calculatedWeight}lb`;
        }
        tdName.innerHTML = `
          <div class="exercise-name">${exercise.name}</div>
          <div class="prescribed">${prescribedText}</div>
        `;
        
        // Log inputs
        const tdLog = document.createElement('td');
        const logDiv = document.createElement('div');
        
        const inputsDiv = document.createElement('div');
        inputsDiv.className = 'log-inputs';
        
        const setsInput = document.createElement('input');
        setsInput.type = 'number';
        setsInput.placeholder = 'Sets';
        setsInput.min = '1';
        setsInput.max = '10';
        setsInput.value = '1';
        setsInput.id = `sets-${idx}`;
        
        const repsInput = document.createElement('input');
        repsInput.type = 'number';
        repsInput.placeholder = 'Reps';
        repsInput.min = '0';
        repsInput.id = `reps-${idx}`;
        if (suggestedReps) {
          repsInput.placeholder = suggestedReps;
        }
        
        const weightInput = document.createElement('input');
        weightInput.type = 'number';
        weightInput.placeholder = 'Weight (lb)';
        weightInput.min = '0';
        weightInput.step = '2.5';
        weightInput.id = `weight-${idx}`;
        if (calculatedWeight) {
          weightInput.value = calculatedWeight;
          weightInput.style.background = 'rgba(125, 211, 252, 0.1)'; // Highlight calculated
        }
        
        const addBtn = document.createElement('button');
        addBtn.className = 'add-set-btn';
        addBtn.textContent = 'Add Set';
        addBtn.onclick = () => logSet(workoutId, idx, exercise.name);
        
        inputsDiv.appendChild(setsInput);
        inputsDiv.appendChild(repsInput);
        inputsDiv.appendChild(weightInput);
        
        // Display logged sets
        const loggedDiv = document.createElement('div');
        loggedDiv.className = 'logged-sets';
        loggedDiv.id = `logged-${idx}`;
        updateLoggedSets(workoutId, idx);
        
        logDiv.appendChild(inputsDiv);
        logDiv.appendChild(addBtn);
        logDiv.appendChild(loggedDiv);
        tdLog.appendChild(logDiv);
        
        tr.appendChild(tdName);
        tr.appendChild(tdLog);
        tbody.appendChild(tr);
      });
    }

    function hideWorkout() {
      currentWorkout = null;
      document.getElementById('empty-state').style.display = 'block';
      document.getElementById('workout-card').style.display = 'none';
      document.getElementById('timer-card').style.display = 'none'; // Hide timer
    }

    function logSet(workoutId, exerciseIdx, exerciseName) {
      const sets = document.getElementById(`sets-${exerciseIdx}`).value;
      const reps = document.getElementById(`reps-${exerciseIdx}`).value;
      const weight = document.getElementById(`weight-${exerciseIdx}`).value;
      
      if (!reps || !weight) {
        alert('Please enter reps and weight');
        return;
      }

      const numSets = parseInt(sets) || 1;

      // Initialize workout log structure
      if (!workoutLog[workoutId]) {
        workoutLog[workoutId] = {};
      }
      if (!workoutLog[workoutId][exerciseName]) {
        workoutLog[workoutId][exerciseName] = [];
      }

      // Add the sets
      for (let i = 0; i < numSets; i++) {
        workoutLog[workoutId][exerciseName].push({
          reps: parseInt(reps),
          weight: parseFloat(weight),
          timestamp: new Date().toISOString()
        });
      }

      // Clear inputs
      document.getElementById(`sets-${exerciseIdx}`).value = '1';
      document.getElementById(`reps-${exerciseIdx}`).value = '';
      document.getElementById(`weight-${exerciseIdx}`).value = '';

      // Update display
      updateLoggedSets(workoutId, exerciseIdx);
      saveState();
    }

    function updateLoggedSets(workoutId, exerciseIdx) {
      const workout = WORKOUTS[workoutId];
      const exercise = workout.exercises[exerciseIdx];
      const loggedDiv = document.getElementById(`logged-${exerciseIdx}`);
      
      if (!loggedDiv) return;

      const sets = workoutLog[workoutId]?.[exercise.name] || [];
      
      if (sets.length === 0) {
        loggedDiv.innerHTML = '';
        return;
      }

      loggedDiv.innerHTML = '<div style="color: var(--muted); font-size: 13px; margin-bottom: 6px;">Logged:</div>' + 
        sets.map((set, i) => 
          `<span class="logged-set">${set.weight}lb √ó ${set.reps}</span>`
        ).join('');
    }

    // ============================================
    // REST TIMER
    // ============================================

    function setTimer(seconds) {
      timerSeconds = seconds;
      updateTimerDisplay();
      startTimer(); // Auto-start timer
    }

    function startTimer() {
      if (timerInterval) return;
      if (timerSeconds === 0) {
        alert('Set a timer duration first (30s, 60s, or 90s)');
        return;
      }

      timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerDisplay();

        if (timerSeconds === 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          
          // Notification
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Rest Complete!', {
              body: 'Time for next set',
              icon: './icon-192.png'
            });
          }
          
          // Vibration
          if ('vibrate' in navigator) {
            navigator.vibrate([200, 100, 200]);
          }
          
          alert('Rest complete! üí™');
        }
      }, 1000);
    }

    function pauseTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function resetTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerSeconds = 0;
      updateTimerDisplay();
    }

    function updateTimerDisplay() {
      const display = document.getElementById('timer-display');
      const mins = Math.floor(timerSeconds / 60);
      const secs = timerSeconds % 60;
      display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // ============================================
    // SAVE/LOAD/EXPORT
    // ============================================

    function saveWorkout() {
      const json = JSON.stringify(workoutLog, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `workout-log-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      alert('Workout log saved! üíæ');
    }

    function loadWorkout() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            workoutLog = JSON.parse(e.target.result);
            saveState();
            if (currentWorkout) {
              displayWorkout(currentWorkout);
            }
            alert('Workout log loaded! üìÇ');
          } catch (err) {
            alert('Failed to load file. Invalid JSON.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function exportWorkout() {
      if (!currentWorkout) {
        alert('Select a workout first');
        return;
      }

      const workout = WORKOUTS[currentWorkout];
      let text = `${workout.name}\n${'='.repeat(workout.name.length)}\n\n`;

      workout.exercises.forEach(exercise => {
        text += `${exercise.name}\n`;
        text += `Prescribed: ${exercise.prescribed}\n`;
        
        const sets = workoutLog[currentWorkout]?.[exercise.name] || [];
        if (sets.length > 0) {
          text += 'Logged: ';
          text += sets.map(s => `${s.weight}lb √ó ${s.reps}`).join(', ');
          text += '\n';
        }
        text += '\n';
      });

      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${workout.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      alert('Workout exported! üì§');
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    window.addEventListener('DOMContentLoaded', () => {
      loadState();
      initWorkoutSelect();
      updateTimerDisplay();
      
      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
        setTimeout(() => Notification.requestPermission(), 2000);
      }
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
